<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
    	<title>Test</title>
    	<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
	    <link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css' />
	    <script src='http://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js'></script>

	    <link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css' />
	    <script src='http://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js'></script>

	    <script src='http://cdn.rawgit.com/turban/Leaflet.Sync/0.0.5/L.Map.Sync.js'></script>

		<link rel= "stylesheet" type = "text/css"
		    href = "{{ url_for('static', filename = 'style.css') }}">

		<link rel= "stylesheet" type = "text/css"
		    href = "{{ url_for('static', filename = 'bootstrap.min.css') }}">    
	</head>

	<body>
   	<div class="container-fluid">
	    <h1>Test</h1>

	    <div id="dialog">
			<input id="commandLine" type="text" placeholder="New command">
		</div>

		{% for n in range(nbMaps) %}
		    <!-- <p> number {{ n }} </p> -->
		    <div class='mapContainer'>
			   <div id='title{{ n }}' class='title'>TITLE {{n}}</div>
			   <div id='map{{ n }}' class='map'></div>
			   <div id='key{{ n }}' class='key'><img /></div>
			</div>
		{% endfor %}

		<!-- <form action = "{{ url_for('api_slippymaps_maplayer') }}" method = "POST"> -->
		<form action = "/slippymaps_maplayer" method = "POST">	
			
			<input type="text" name="nummaps" > number of maps to add <br>
			<input type="text" name="mapvar" > ferret variable <br>
	        <input type="text" name="ferretcmd"> ferret command
	        <br><br>
	        <input type="submit" value="Submit" />
	  	</form>

	  	<br>

	 	{% if nummaps: %}
	 		<p> {{ nummaps }} maps added below:</p>
	 	 	
	 	 	{% for n in range(nbMaps, nummaps + nbMaps) %}
			 	<p> n: {{ n }} </p>
			 	<div id='title{{ n }}' class='title'>TITLE {{n}}</div>
			   	<div id='map{{ n }}' class='map'></div>
			   	<div id='key{{ n }}' class='key'><img /></div>
			{% endfor %}

	 		
	 	{% else %}
	 		<p> No maps to add. </p>
	  	{% endif %}
	 

	  	<br><br>

		<script type='text/javascript'>

			//===============================================
			var crs = L.CRS.EPSG4326;

			var map = [];
			var wmspyferret = [];
			var frontiers= [];

			//===============================================
			wmspyferret[0] = L.tileLayer.wms('http://localhost:8000/slippymaps_maplayer', {
				command: 'shade/x=-180:180/y=-90:90/lev=20v/pal=mpl_PSU_inferno',
				variable: 'temp[k=@max]',
			    	crs: crs,
				format: 'image/png',
				transparent: true,
			    	uppercase: true
			});

			frontiers[0] = L.tileLayer.wms('http://www.globalcarbonatlas.org:8080/geoserver/GCA/wms', {
				layers: 'GCA:GCA_frontiersCountryAndRegions',
				format: 'image/png',
			    	crs: crs,
				transparent: true
			});

			map[0] = L.map('map0', {
			    layers: [wmspyferret[0], frontiers[0]],
			    crs: crs,
			    center: [0,-40],
			    zoom: 1,
			    attributionControl: false
			});

			//===============================================
			wmspyferret[1] = L.tileLayer.wms('http://localhost:8000/slippymaps_maplayer', {
				command: 'shade/x=-180:180/y=-90:90/lev=20v/pal=mpl_Seq1_RdPu',
				variable: 'salt[k=@var]',
			    	crs: crs,
				format: 'image/png',
				transparent: true,
			    	uppercase: true
			});
			frontiers[1] = L.tileLayer.wms('http://www.globalcarbonatlas.org:8080/geoserver/GCA/wms', {
				layers: 'GCA:GCA_frontiersCountryAndRegions',
				format: 'image/png',
			    	crs: crs,
				transparent: true
			});

			map[1] = L.map('map1', {
			    layers: [wmspyferret[1], frontiers[1]],
			    crs: crs,
			    center: [0,-40],
			    zoom: 1,
			    attributionControl: false
			});

			//===============================================
			// Set up synchro between maps


			//===============================================
			function getTitle(aCommand, aVariable) {
				// Inspect command to get /title qualifier if present
				m = aCommand.match(/title=([\w&]+)/);		// equivalent to search in python
				if (m != null)
					title = m[1]
				else 
					title = aVariable 
				return title
			}

			//===============================================
			{% for n in range(nbMaps) -%}
				title{{ n }} = getTitle(wmspyferret[{{ n }}].wmsParams.command, wmspyferret[{{ n }}].wmsParams.variable.replace('%2B','+'));
				$('#title{{ n }}').html(title{{ n }});   
				$('#title{{ n }}').attr('title', wmspyferret[{{ n }}].wmsParams.command + ' ' + wmspyferret[{{ n }}].wmsParams.variable.replace('%2B','+'));   				
				$('#key{{ n }}').children('img').attr('src', 'http://localhost:8000/slippymaps_maplayer?SERVICE=WMS&REQUEST=GetColorBar' +
											'&COMMAND=' + wmspyferret[{{ n }}].wmsParams.command +
											'&VARIABLE=' + wmspyferret[{{ n }}].wmsParams.variable.replace('+','%2B'));

			{% endfor %}

		</script>


  	</div> <!-- ./container --> 
  </body>
</html>