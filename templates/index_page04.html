<!doctype html>
<html>
	<head>
		<title>Get/Explore Data</title>
	</head>

	<body>
   
   		{% extends "layout.html" %}
		{% block content %}

		<div class="row">
	    	<h2>Changes in stressor intensity in 2090&ndash;2099 relative to 1990&ndash;1999</h2>
	    	Select a stressor to view its intensity change under all RCP scenarios or select a scenario to view intensity changes of all four stressors.
	    </div>
		   

    		<fieldset id="dimension" class="userChoices">
		  <!-- <legend>Select</legend> -->

		  <input class="dimensionInput" type="radio" name="radio-0" value="variable" checked>
		  <label>stressor:</label>
		  <fieldset id="variable" class="userChoices">
		    <input class="variableInput" type="radio" name="radio-1" value="D_SST" checked>
		    <label>&delta; SST</label>
		    <input class="variableInput" type="radio" name="radio-1" value="D_PH">
		    <label>&delta; pH</label>
		    <input class="variableInput" type="radio" name="radio-1" value="D_O2">
		    <label>&delta; O2</label>
		    <input class="variableInput" type="radio" name="radio-1" value="D_INTPP">
		    <label>&delta; intPP</label>
		  </fieldset>

		  <input class="dimensionInput" type="radio" name="radio-0" value="scenario">
		  <label>scenario:</label>
		  <fieldset id="scenario" class="userChoices">
		    <input class="scenarioInput" type="radio" name="radio-2" value="RCP85" checked>
		    <label>RCP 8.5</label>
		    <input class="scenarioInput" type="radio" name="radio-2" value="RCP60">
		    <label>RCP 6.0</label>
		    <input class="scenarioInput" type="radio" name="radio-2" value="RCP45">
		    <label>RCP 4.5</label>
		    <input class="scenarioInput" type="radio" name="radio-2" value="RCP26">
		    <label>RCP 2.6</label>
		  </fieldset>

		</fieldset>

	    <div id="dialog">
			<input id="commandLine" type="text" placeholder="New command">
		</div>

	  	<!-- Containers for pre-defined maps -->
	  	{% for aDict in cmdArray -%}
	  		<div class='mapContainer'>
	  			 
				<div id='title{{ loop.index }}' class='title'></div>
			    <div id='map{{ loop.index }}' class='map'></div>
			    <div id='key{{ loop.index }}' class='key'><img /></div>
			    <button id='edit{{ loop.index }}' type="button" class="edit btn btn-default btn-xs">Edit palette</button>	
			</div>
	  	{% endfor %}


		<p></p>
		<div id="timeSeries" class='btn btn-default'>Timeseries</div>
		<div id="button_save" class='btn btn-default'>Save Maps</div>

		<br><br>

	
		<script type='text/javascript'>

			//===============================================
			var crs = L.CRS.EPSG4326;

			var map = [];
			var wmspyferret_var = [];
			var wmspyferret_mask = [];
			var frontiers= [];

			var scenarioList = ['RCP85', 'RCP60', 'RCP45', 'RCP26'];
			var variableList = ['D_SST', 'D_PH', 'D_O2', 'D_INTPP'];

			var qualifiersList = { 'D_SST': '/lev=(-INF)(-4,4,0.5)(INF)/pal=blue_orange.spk',
                       'D_PH':  '/lev=(-INF)(-0.5,0.5,0.05)(INF)/pal=brown_green.spk',
                       'D_O2':  '/lev=(-INF)(-50,50,5)(INF)/pal=darkorange_blue.spk',
                       'D_INTPP':  '/lev=(-INF)(-200,200,10)(INF)/pal=magenta_green.spk' };

            var titleDict = {
            	'D_SST_RCP85': 'Sea surface temperature change (RCP 8.5)',
            	'D_SST_RCP60': 'Sea surface temperature change (RCP 6.0)',
            	'D_SST_RCP45': 'Sea surface temperature change (RCP 4.5)',
            	'D_SST_RCP26': 'Sea surface temperature change (RCP 2.6)',

            	'D_PH_RCP85': 'Sea surface pH change (RCP 8.5)',
            	'D_PH_RCP60': 'Sea surface pH change (RCP 6.0)',
            	'D_PH_RCP45': 'Sea surface pH change (RCP 4.5)',
            	'D_PH_RCP26': 'Sea surface pH change (RCP 2.6)',

            	'D_O2_RCP85': 'Oxygen concentration change at 200-600m (RCP 8.5)',
            	'D_O2_RCP60': 'Oxygen concentration change at 200-600m (RCP 6.0)',
            	'D_O2_RCP45': 'Oxygen concentration change at 200-600m (RCP 4.5)',
            	'D_O2_RCP26': 'Oxygen concentration change at 200-600m (RCP 2.6)',

            	'D_INTPP_RCP85': 'Integrated net primary productivity change (RCP 8.5)',
            	'D_INTPP_RCP60': 'Integrated net primary productivity change (RCP 6.0)',
            	'D_INTPP_RCP45': 'Integrated net primary productivity change (RCP 4.5)',
            	'D_INTPP_RCP26': 'Integrated net primary productivity change (RCP 2.6)'
            };
       
             
			//===============================================			
			{% for aDict in cmdArray -%}
				wmspyferret_var[{{ loop.index }}] = L.tileLayer.wms('http://webportals.ipsl.jussieu.fr/gunicorn1', {
					command: 'shade/x=-180:180/y=-90:90/QQQQQ',
					variable: 'VVVVV_SSSSS[m=1:5@ave]',
				    	crs: crs,
					format: 'image/png',
					transparent: true,
				    	uppercase: true
				});
				frontiers[{{ loop.index }}] = L.tileLayer.wms('http://www.globalcarbonatlas.org/geoserver/GCA/wms', {
					layers: 'GCA:GCA_frontiersCountryAndRegions',
					format: 'image/png',
				    	crs: crs,
					transparent: true
				});
				wmspyferret_mask[{{ loop.index }}] = L.tileLayer.wms('http://webportals.ipsl.jussieu.fr/gunicorn1', {
					command: 'shade/x=-180:180/y=-90:90/pal=gray/lev=(1)',
					variable: 'MASK_VVVVV_SSSSS[m=1:5]',
					mask: '/var/www/html/ScientificApps/dev/forge_patrick/wms-pyferret/square.png',
				    	crs: crs,
					format: 'image/png',
					transparent: true,
				    	uppercase: true
				});

				map[{{ loop.index }}] = L.map('map{{ loop.index }}', {
				    layers: [wmspyferret_var[{{ loop.index }}], frontiers[{{ loop.index }}], wmspyferret_mask[{{ loop.index }}]],
				    crs: crs,
				    center: [0,-40],
				    zoom: 1,
				    attributionControl: false
				});
				

			{% endfor %}
			
			//===============================================
			// Set up synchro between maps
			{% for synchro in listSynchroMapsToSet %}
				map[{{ synchro[0] }}].sync(map[{{ synchro[1] }}]);
			{% endfor %}

			//===============================================
			//Get leaflet map bounds (default view upon page load):
			function getBds() {
				var bds=[]
				bds = [
					map[1].getBounds().getEast(),
				    map[1].getBounds().getWest(),
				    map[1].getBounds().getNorth(),
				    map[1].getBounds().getSouth()
				];

				//bounds after zoom
				map[1].on('moveend', function() {
				    var east = map[1].getBounds().getEast(),
				        west = map[1].getBounds().getWest(),
				        north = map[1].getBounds().getNorth(),
				        south = map[1].getBounds().getSouth();

				    bds = [east, west, north, south];
				    console.log("bds on zoom: ", bds);

				});

				return bds;
			}

			//===============================================
			//Define buttons and pass paramteters to route
			$("#button_ts").click(function(){
				bds = getBds();
				console.log("bds in button: ", bds)				
				window.open('/timeseries?&REQUEST=getTimeseries&BDS=' + bds, "_self");
					return false;
			});

			// http://codepen.io/anon/pen/RWraBJ
			$("#button_save").click(function(){				
		        // $('#map{{loop.index}}').print();
		    });
		

			//===============================================
			function getTitle(aCommand, aVariable) {

				// Inspect command to get /title qualifier if present
				m = aCommand.match(/title=([\w&]+)/); // equivalent to search in python
				if (m != null)
					title = m[1];
				else 
					title = aVariable;
					title = title.split('[')[0];
					title = titleDict[title];
				
				return title
			}

			//===============================================
			// Click edit button to open command line popup
			$('.edit').on('click', function() {
			    
				mapId = $(this).attr('id').replace('edit','');
				id = 'title' + mapId;

				$('#commandLine').val($('#'+id).attr('title'));
				console.log("edit commandLine: ", $('#commandLine').val($('#'+id).attr('title')) )
				$('#commandLine').attr('mapId', mapId);
				$('#dialog').dialog({ title: 'Command line for map #'+mapId, modal: false, width: 600, height: 100,
					position: {my: "left+30 top+30", at: "left", of: this} });

				// $('#title'+mapId).attr('title', command.split('(INF)/')[1]);
				
			});


			//===============================================
			// Send new command after pressing enter on command line
			$('#commandLine').on('keypress', function(e) {
			    if(e.which === 13) {
			
			        commandLine = $(this).val().split(' ');
			        console.log("keypress commandLine: ", commandLine)
			        command = commandLine[0];
			        commandLine.shift();
			        variable = commandLine.join(' ');
			        
			        
			        
					// mapId = $(this).attr('mapId');
					// console.log("keypress title: ", $('#title' + mapId).attr('title'))
					// command_full = $('#title' + mapId).attr('title');
					// console.log("command_full: ", command_full)
					// command = command_full.split(' ')[0];
					// variable = command_full.split(' ')[1];
					// console.log("command: ", command)
			  //       console.log("variable: ", variable)

					
			        wmspyferret_var[mapId].setParams({ command: command, variable: variable.replace('+','%2B') });

			     
		
					title = getTitle(command, variable);
					
					
			        $('#title'+mapId).html(title);
			        $('#title'+mapId).attr('title', command + ' ' + variable);
					$('#key'+mapId).children('img').attr('src', 'http://webportals.ipsl.jussieu.fr/gunicorn1/?SERVICE=WMS&REQUEST=GetColorBar' +
										'&COMMAND=' + command +
										'&VARIABLE=' + variable.replace('+','%2B'));
			    }
			});


			//===============================================
			//Radio buttons
			$('#dimension').on('change', function() {				
				dimensionToDisplay = $('.dimensionInput:checked').val();
				variableToDisplay = $('.variableInput:checked').val();
				scenarioToDisplay = $('.scenarioInput:checked').val();

				$('#dimension').children().children().prop('disabled', true);
				$('#dimension').children().children().attr('style', 'color: gray');
				$('#'+dimensionToDisplay).children().prop('disabled', false);
				$('#'+dimensionToDisplay).children().attr('style', 'color: black');

				for (mapId = 1; mapId <= {{nbMaps}} ; mapId++) { 
					command = 'shade/x=-180:180/y=-90:90/QQQQQ';
					variable =  'VVVVV_SSSSS[m=1:5@ave]';
					mask =  'MASK_VVVVV_SSSSS[m=1:5]';
					if (dimensionToDisplay == 'variable') {
						command = command.replace('QQQQQ', qualifiersList[variableToDisplay]);
						variable = variable.replace('VVVVV', variableToDisplay);
						variable = variable.replace('SSSSS', scenarioList[mapId-1]);
						mask = mask.replace('VVVVV', variableToDisplay);
						mask = mask.replace('SSSSS', scenarioList[mapId-1]);
					} else { 
						command = command.replace('QQQQQ', qualifiersList[variableList[mapId-1]]);
						variable = variable.replace('VVVVV', variableList[mapId-1]);
						variable = variable.replace('SSSSS', scenarioToDisplay);
						mask = mask.replace('VVVVV', variableList[mapId-1]);
						mask = mask.replace('SSSSS', scenarioToDisplay);
					}
					title = getTitle(command, variable);					
			    	wmspyferret_var[mapId].setParams({ command: command, variable: variable.replace('+','%2B') });
			    	wmspyferret_mask[mapId].setParams({ variable: mask.replace('+','%2B') });
			    	$('#title'+mapId).html(title);
			    	
			    	$('#title'+mapId).attr('title', command + ' ' + variable);			    	
					
					$('#key'+mapId).children('img').attr('src', 'http://webportals.ipsl.jussieu.fr/gunicorn1/?SERVICE=WMS&REQUEST=GetColorBar' +
											'&COMMAND=' + command +
											'&VARIABLE=' + variable.replace('+','%2B'));
				}

			});

			$('#dimension').change();

			//===============================================
			n=1;
			$('#timeSeries').on('click', function() {
			    console.log("here");

				$('body').append("<div id='ts"+n+"'></div>") 

			                   $('#ts'+n).dialog({
				title: "Time Series #"+n,
			                        width: 830,
			                        height: 660,
			                   });
			                n++;
			});


		</script>

		{% endblock %}
  	
  </body>
</html>