<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
    	<title>Slippymaps</title>
    	<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
	    <link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css' />
	    <script src='http://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js'></script>

	    <link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css' />
	    <script src='http://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js'></script>

	    <script src='http://cdn.rawgit.com/turban/Leaflet.Sync/0.0.5/L.Map.Sync.js'></script>

		<link rel= "stylesheet" type = "text/css"
		    href = "{{ url_for('static', filename = 'style.css') }}">

		<link rel= "stylesheet" type = "text/css"
		    href = "{{ url_for('static', filename = 'bootstrap.min.css') }}">    
	</head>

	<body>
   	<div class="container-fluid">
	    <h2>Add map</h2>

	    <div id="dialog">
			<input id="commandLine" type="text" placeholder="New command">
		</div>

		
		<!-- Request form to add map -->
		<form action = "/" method = "POST">
			<input type="text" name="dataset" size="55"> dataset (e.g. levitus_climatology) <br>
			<input type="text" name="mapvar" size="55"> ferret variable (e.g. temp[k=@max])<br>
	        <input type="text" name="ferretcmd" size="55"> ferret command (e.g. shade/x=-180:180/y=-90:90/lev=20v/pal=mpl_PSU_inferno)<br>
	        <input type="text" name="postvar" size="55"> OPTIONAL: post-variable arguments (e.g. nav_lon, nav_lat)
	        <br><br>
	        <input type="submit" value="Submit" />
	  	</form>
	  	<br><br><br>

	  	<!-- Add map requested by user in form -->
		{% for aDict in cmdArray -%}			
			<p>
				Map number: {{loop.index}} <br>
				dataset: {{dataset}}<br>		
			  	variable: {{aDict.variable}} <br>
			  	command: {{aDict.command}}			
			</p>
			<div class='mapContainer'>
			   <div id='title{{ loop.index }}' class='title'></div>
			   <div id='map{{ loop.index }}' class='map'></div>
			   <div id='key{{ loop.index }}' class='key'><img /></div>
			</div>
		{% endfor -%}

  		
		<script type='text/javascript'>

			//===============================================
			var crs = L.CRS.EPSG4326;

			var map = [];
			var wmspyferret = [];
			var frontiers= [];

			//===============================================
			{% for aDict in cmdArray -%}

				wmspyferret[{{ loop.index }}] = L.tileLayer.wms('http://localhost:8000/showmaps_resource?DSET={{dataset}}&POSTVAR={{postvar}}', {
					command: '{{ aDict.command }}',
					variable: '{{ aDict.variable }}',
				    	crs: crs,
					format: 'image/png',
					transparent: true,
				    	uppercase: true
				});

				frontiers[{{ loop.index }}] = L.tileLayer.wms('http://www.globalcarbonatlas.org:8080/geoserver/GCA/wms', {
					layers: 'GCA:GCA_frontiersCountryAndRegions',
					format: 'image/png',
				    	crs: crs,
					transparent: true
				});

				map[{{ loop.index }}] = L.map('map{{ loop.index }}', {
				    layers: [wmspyferret[{{ loop.index }}], frontiers[{{ loop.index }}]],
				    crs: crs,
				    center: [0,-40],
				    zoom: 1,
				    attributionControl: false
				});
			{% endfor %}	

			//===============================================
			// Set up synchro between maps
			// {% for synchro in listSynchroMapsToSet %}				
			// 	map[{{ synchro[0] }}].sync(map[{{ synchro[1] }}]);
			// {% endfor %}

			//===============================================
			function getTitle(aCommand, aVariable) {
				// Inspect command to get /title qualifier if present
				m = aCommand.match(/title=([\w&]+)/);		// equivalent to search in python
				if (m != null)
					title = m[1]
				else 
					title = aVariable 
				return title
			}

			//===============================================
			{% for aDict in cmdArray -%}
				// title0 = getTitle(wmspyferret[0].wmsParams.command, wmspyferret[0].wmsParams.variable.replace('%2B','+'));
				// $('#title0').html(title1);
				// $('#title0').attr('title', wmspyferret[0].wmsParams.command + ' ' + wmspyferret[0].wmsParams.variable.replace('%2B','+'));   
				// $('#key0').children('img').attr('src', 'http://localhost:8000/showmaps_resource?SERVICE=WMS&REQUEST=GetColorBar' +
				// 			'&COMMAND=' + wmspyferret[0].wmsParams.command +
				// 			'&VARIABLE=' + wmspyferret[0].wmsParams.variable.replace('+','%2B'));

				$('#key{{ loop.index }}').children('img').attr('src', 'http://localhost:8000/showmaps_resource?DSET={{dataset}}&POSTVAR={{postvar}}&SERVICE=WMS&REQUEST=GetColorBar' +
										'&COMMAND=' + wmspyferret[{{ loop.index }}].wmsParams.command +
										'&VARIABLE=' + wmspyferret[{{ loop.index }}].wmsParams.variable.replace('+','%2B'));
			{% endfor %}
						

			
		</script>


  	</div> <!-- ./container --> 
  </body>
</html>